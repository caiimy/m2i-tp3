name: CI Pipeline
 
on: push
 
jobs:
 
  clone-repo:
    runs-on: ubuntu-latest
 
    steps:
    # - name: git clone repo
    #   run: |
    #     git clone https://github.com/vanessakovalsky/python-api-handle-it.git
    - name: Checkout
      uses: actions/checkout@v2
      with:
        repository: vanessakovalsky/python-api-handle-it
        path: ./python-api-handle-it

    - name: Access cloned repository content
      working-directory: python-api-handle-it
      run: |
        ls
        echo "Repo cloned"
        cd app
        ls

    - name: Save repo 
      uses: actions/upload-artifact@v2
      with:
        name: upload artifact repo
        path: ./python-api-handle-it

  lint:
 
    needs: clone-repo
 
    runs-on: ubuntu-latest
 
    steps:
    - name: download artifact
      uses: actions/download-artifact@v2
      with:
        name: upload artifact repo

    - name: Install dependencies
      run: |
        cd app
        pip install -r requirements.txt
        pip install pylint
 
    - name: Lint code
      run: | 
        pwd
        echo "---------------------"
        mkdir report
        ls
        echo "----------------------------"
        cd report
        ls
        echo "----------------------------"
        pylint **/*.py --fail-under=5 --output-format=text > pylint-report.txt
 
    - name: Save lint report
      uses: actions/upload-artifact@v2
      with:
        name: pylint-report
        path: ./python-api-handle-it
 
  cyclomatic:
 
    needs: lint
 
    runs-on: ubuntu-latest
 
    steps:
 
    - name: download artifact
      uses: actions/download-artifact@v2
      with:
        name: pylint-report
 
    - name: Install dependencies
      run: |
        pip install radon
 
    - name: Check complexity
      run: |
        radon cc -s -a -nb --total-average --output-file=./report/complexity-report.txt .
 
    - name: Upload Complexity Report
      uses: actions/upload-artifact@v3
      with:
        name: complexity-report
        path: ./python-api-handle-it
 
  test:
 
    needs: cyclomatic
 
    runs-on: ubuntu-latest
 
    steps:
 
    - name: download artifact
      uses: actions/download-artifact@v2
      with:
        name: complexity-report
 
    - name: Install dependencies
      run: |
        cd app
        pip install -r requirements.txt
 
    - name: Run tests
      run: |
        python -m unittest test/unit/test.py
 
    - name: Upload Test Report
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test/unit/test-report.xml
 
  build:
 
    needs: [test, cyclomatic, lint]
 
    runs-on: ubuntu-latest
 
    steps:
 
    - uses: actions/checkout@v3
 
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
 
    - name: Build image
      run: |
        docker build . --file Dockerfile --tag myimage:1.0.0
 
    - name: Push image
      run: | 
        docker push myimage:1.0.0